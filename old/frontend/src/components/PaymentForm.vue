<template>
  <div class="min-h-screen bg-gradient-to-br from-slate-950 via-gray-900 to-black flex items-center justify-center py-4 px-4 xs:px-3 sm:py-12 sm:px-6 lg:px-8 relative pt-safe-top pb-safe-bottom">
    <!-- ERP èƒŒæ™¯ç¶²æ ¼ -->
    <div class="absolute inset-0 overflow-hidden">
      <!-- ç¶²æ ¼ç·š -->
      <div class="absolute inset-0 bg-grid-pattern opacity-5"></div>
      <!-- æƒæç·šæ•ˆæœ -->
      <div class="absolute inset-0">
        <div class="absolute top-0 left-0 w-full h-px bg-gradient-to-r from-transparent via-cyan-400/30 to-transparent animate-scan-line"></div>
      </div>
      <!-- ç§‘æŠ€æ„Ÿå…‰æšˆ -->
      <div class="absolute -top-40 -right-40 w-80 h-80 bg-cyan-500/5 rounded-full blur-3xl"></div>
      <div class="absolute -bottom-40 -left-40 w-80 h-80 bg-emerald-500/5 rounded-full blur-3xl"></div>
      <!-- æ•¸æ“šæµç·šæ¢ -->
      <div class="absolute top-1/4 left-0 w-full h-px bg-gradient-to-r from-transparent via-emerald-400/20 to-transparent opacity-40"></div>
      <div class="absolute top-3/4 left-0 w-full h-px bg-gradient-to-r from-transparent via-cyan-400/20 to-transparent opacity-40"></div>
    </div>
    
    <!-- ç”¨æˆ¶ä¿¡æ¯é¡¯ç¤º - éŸ¿æ‡‰å¼ç‰ˆæœ¬ -->
    <div class="absolute top-4 right-4 xs:top-3 xs:right-3 flex items-center space-x-2 sm:space-x-4 z-50">
      <!-- æ¡Œé¢ç‰ˆ -->
      <div class="hidden sm:flex items-center space-x-4">
        <button
          @click="goToAdmin"
          class="flex items-center space-x-2 bg-blue-600/90 hover:bg-blue-700 backdrop-blur-xl border border-blue-500/50 rounded-lg px-4 py-2 text-white text-sm font-medium transition-colors duration-200"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
          </svg>
          <span>ç®¡ç†å¾Œå°</span>
        </button>
        <button
          @click="goToOrders"
          class="flex items-center space-x-2 bg-emerald-600/90 hover:bg-emerald-700 backdrop-blur-xl border border-emerald-500/50 rounded-lg px-4 py-2 text-white text-sm font-medium transition-colors duration-200"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
          </svg>
          <span>å®¢è¨‚å–®ç®¡ç†</span>
        </button>
        <div class="flex items-center space-x-2 bg-gray-800/50 backdrop-blur-xl border border-gray-700/50 rounded-lg px-4 py-2">
          <div class="flex items-center space-x-2">
            <div class="w-2 h-2 bg-green-500 rounded-full"></div>
            <span class="text-sm text-gray-300">ç™»å…¥ç”¨æˆ¶ï¼š</span>
            <span class="text-sm font-medium text-white">{{ currentUser || 'æœªçŸ¥' }}</span>
          </div>
        </div>
        <button
          @click="logout"
          class="flex items-center space-x-2 bg-red-600/90 hover:bg-red-700 backdrop-blur-xl border border-red-500/50 rounded-lg px-4 py-2 text-white text-sm font-medium transition-colors duration-200"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
          </svg>
          <span>ç™»å‡º</span>
        </button>
      </div>
      
      <!-- æ‰‹æ©Ÿç‰ˆ - å„ªåŒ–ä½ˆå±€é˜²æ­¢é‡ç–Š -->
      <div class="sm:hidden">
        <div class="flex items-center justify-end space-x-1.5 xs:space-x-1 mb-2">
          <button
            @click="goToAdmin"
            class="flex items-center justify-center w-9 h-9 xs:w-10 xs:h-10 min-w-touch min-h-touch bg-slate-800/95 hover:bg-slate-700 backdrop-blur-xl border border-cyan-500/60 rounded-lg text-cyan-100 transition-all duration-200 hover:border-cyan-400/80 hover:shadow-lg hover:shadow-cyan-500/25 shadow-md"
            title="ç®¡ç†å¾Œå°"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
          </button>
          <button
            @click="goToOrders"
            class="flex items-center justify-center w-9 h-9 xs:w-10 xs:h-10 min-w-touch min-h-touch bg-slate-800/95 hover:bg-emerald-700 backdrop-blur-xl border border-emerald-500/60 rounded-lg text-emerald-100 transition-all duration-200 hover:border-emerald-400/80 hover:shadow-lg hover:shadow-emerald-500/25 shadow-md"
            title="å®¢è¨‚å–®ç®¡ç†"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
          </button>
          <button
            @click="logout"
            class="flex items-center justify-center w-9 h-9 xs:w-10 xs:h-10 min-w-touch min-h-touch bg-slate-800/95 hover:bg-red-900/60 backdrop-blur-xl border border-red-500/60 rounded-lg text-red-200 transition-all duration-200 hover:border-red-400/80 hover:shadow-lg hover:shadow-red-500/25 shadow-md"
            title="ç™»å‡º"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
            </svg>
          </button>
        </div>
        <div class="flex items-center justify-end">
          <div class="flex items-center space-x-2 bg-slate-900/80 backdrop-blur-xl border border-emerald-500/60 rounded-lg px-2.5 py-1.5 xs:px-2 xs:py-1 shadow-md">
            <div class="w-1.5 h-1.5 bg-emerald-400 rounded-full animate-pulse"></div>
            <span class="text-xs xs:text-xs-mobile font-medium text-emerald-100">{{ currentUser || 'æœªçŸ¥' }}</span>
          </div>
        </div>
      </div>
    </div>
    
    <div class="relative w-full max-w-7xl mx-auto px-4">

      <!-- æ¨™é¡Œå€åŸŸ - ç·Šæ¹Šç‰ˆ -->
      <div class="text-center mb-4 mt-20 xs:mt-16 sm:mt-0">
        <h2 class="text-xl sm:text-2xl font-bold bg-gradient-to-r from-cyan-300 via-white to-emerald-300 bg-clip-text text-transparent mb-1 tracking-wide">
          çŸ³é ­äººç…™å…·ä»˜æ¬¾ç³»çµ±
        </h2>
        <div class="text-xs text-cyan-400/70 font-mono tracking-wider">
          ERP PAYMENT MANAGEMENT SYSTEM v3.0
        </div>
      </div>

      <!-- è¡¨å–®å¡ç‰‡ - æ©«å‘ä½ˆå±€ -->
      <div class="bg-slate-900/80 backdrop-blur-xl border border-slate-700/50 rounded-xl shadow-2xl shadow-black/50 p-6 relative overflow-hidden">
        <!-- ERP è¡¨å–®é ‚éƒ¨ç‹€æ…‹æ¢ -->
        <div class="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-cyan-500 via-emerald-500 to-cyan-500"></div>
        
        <!-- è¡¨å–®æ¨™é¡Œå€åŸŸ -->
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center space-x-3">
            <div class="w-2 h-2 bg-emerald-400 rounded-full animate-pulse"></div>
            <span class="text-emerald-300 font-mono text-xs tracking-wider">PAYMENT ENTRY FORM</span>
          </div>
          <div class="text-xs text-slate-400 font-mono">
            ID: {{ new Date().getTime().toString().slice(-6) }}
          </div>
        </div>

        <form @submit.prevent="submitPayment">
          <!-- å­—æ®µé–å®šæ§åˆ¶å€ - ç·Šæ¹Šæ©«å‘ -->
          <div class="bg-slate-800/30 border border-slate-600/50 rounded-lg p-3 mb-4">
            <div class="flex items-center justify-between flex-wrap gap-x-4 gap-y-2">
              <div class="flex items-center space-x-2">
                <svg class="w-3 h-3 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                </svg>
                <span class="text-cyan-300 font-medium text-xs">å­—æ®µé–å®š</span>
              </div>
              <div class="flex flex-wrap gap-x-4 gap-y-2">
                <label class="flex items-center space-x-1.5 cursor-pointer">
                  <input
                    v-model="lockSettings.time"
                    type="checkbox"
                    class="rounded border-gray-600 text-blue-600 focus:ring-blue-500 focus:ring-offset-0 bg-gray-700 w-3.5 h-3.5 flex-shrink-0"
                  />
                  <span class="text-xs text-gray-300">æ™‚é–“</span>
                </label>
                <label class="flex items-center space-x-1.5 cursor-pointer">
                  <input
                    v-model="lockSettings.paymentMethod"
                    type="checkbox"
                    class="rounded border-gray-600 text-blue-600 focus:ring-blue-500 focus:ring-offset-0 bg-gray-700 w-3.5 h-3.5 flex-shrink-0"
                  />
                  <span class="text-xs text-gray-300">ä»˜æ¬¾æ–¹å¼</span>
                </label>
                <label class="flex items-center space-x-1.5 cursor-pointer">
                  <input
                    v-model="lockSettings.amount"
                    type="checkbox"
                    class="rounded border-gray-600 text-blue-600 focus:ring-blue-500 focus:ring-offset-0 bg-gray-700 w-3.5 h-3.5 flex-shrink-0"
                  />
                  <span class="text-xs text-gray-300">é‡‘é¡</span>
                </label>
                <label class="flex items-center space-x-1.5 cursor-pointer">
                  <input
                    v-model="lockSettings.store"
                    type="checkbox"
                    class="rounded border-gray-600 text-blue-600 focus:ring-blue-500 focus:ring-offset-0 bg-gray-700 w-3.5 h-3.5 flex-shrink-0"
                  />
                  <span class="text-xs text-gray-300">åˆ†åº—</span>
                </label>
              </div>
            </div>
          </div>

          <!-- ç¬¬ä¸€è¡Œï¼šæ™‚é–“ã€ä»˜æ¬¾æ–¹å¼ã€åŒ¯æ¬¾å¾Œäº”ç¢¼ã€åˆ†åº— -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3 mb-3">

            <!-- ä»˜æ¬¾æ™‚é–“ -->
            <div class="space-y-1">
              <label for="paid_at" class="flex items-center space-x-1 text-xs font-medium text-gray-200">
                <span>ä»˜æ¬¾æ™‚é–“</span>
                <svg v-if="lockSettings.time" class="w-2.5 h-2.5 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                </svg>
              </label>
              <input
                id="paid_at"
                v-model="form.paid_at"
                type="datetime-local"
                required
                class="block w-full px-2 py-2 bg-gray-700/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 text-sm"
              />
            </div>

            <!-- ä»˜æ¬¾æ–¹å¼ -->
            <div class="space-y-1">
              <label for="payment_method" class="flex items-center space-x-1 text-xs font-medium text-gray-200">
                <span>ä»˜æ¬¾æ–¹å¼</span>
                <svg v-if="lockSettings.paymentMethod" class="w-2.5 h-2.5 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                </svg>
              </label>
              <select
                id="payment_method"
                v-model="form.payment_method"
                required
                class="block w-full px-2 py-2 bg-gray-700/50 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 appearance-none text-sm"
              >
                <option value="" disabled>è«‹é¸æ“‡</option>

                <optgroup label="ä¸€èˆ¬æ”¶æ¬¾">
                  <option value="ç¾é‡‘">ç¾é‡‘</option>
                  <option value="åŒ¯æ¬¾">åŒ¯æ¬¾</option>
                  <option value="é›»å­æ”¯ä»˜">é›»å­æ”¯ä»˜</option>
                  <option value="å®¢è¨‚å–®">å®¢è¨‚å–®</option>
                </optgroup>

                <optgroup label="å“¡å·¥è³¼ç‰©">
                  <option value="å“¡å·¥è³¼ç‰©-ç¾é‡‘">ç¾é‡‘</option>
                  <option value="å“¡å·¥è³¼ç‰©-åŒ¯æ¬¾">åŒ¯æ¬¾</option>
                  <option value="å“¡å·¥è³¼ç‰©-é›»å­æ”¯ä»˜">é›»å­æ”¯ä»˜</option>
                </optgroup>

                <optgroup label="æ”¯å‡ºé …ç›®">
                  <option value="åº—å…§æ”¯å‡º">åº—å…§æ”¯å‡º</option>
                  <option value="æé ˜">æé ˜</option>
                </optgroup>
              </select>
            </div>

            <!-- åŒ¯æ¬¾å¾Œäº”ç¢¼ï¼ˆç•¶é¸æ“‡åŒ¯æ¬¾æˆ–å“¡å·¥è³¼ç‰©-åŒ¯æ¬¾æ™‚é¡¯ç¤ºï¼‰ -->
            <div v-if="form.payment_method === 'åŒ¯æ¬¾' || form.payment_method === 'å“¡å·¥è³¼ç‰©-åŒ¯æ¬¾'" class="space-y-1">
              <label for="last_five" class="block text-xs font-medium text-gray-200">
                åŒ¯æ¬¾å¾Œäº”ç¢¼
              </label>
              <input
                id="last_five"
                v-model="form.last_five"
                type="text"
                :required="form.payment_method === 'åŒ¯æ¬¾'"
                maxlength="5"
                pattern="[0-9]{5}"
                class="block w-full px-2 py-2 bg-gray-700/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 text-sm"
                placeholder="è«‹è¼¸å…¥å¾Œäº”ç¢¼"
              />
            </div>

            <!-- åˆ†åº—é¸æ“‡ -->
            <div class="space-y-1" v-if="stores.length > 0">
              <label for="store_id" class="flex items-center space-x-1 text-xs font-medium text-gray-200">
                <span>é¸æ“‡åˆ†åº—</span>
                <svg v-if="lockSettings.store" class="w-2.5 h-2.5 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                </svg>
              </label>
              <!-- åˆ†åº—å“¡å·¥ï¼šé¡¯ç¤ºé–å®šçš„åˆ†åº— -->
              <div v-if="currentUserStoreId" class="block w-full px-2 py-2 bg-gray-600/50 border border-gray-500 rounded-lg text-white text-sm">
                {{ getCurrentStoreName() }}
              </div>
              <!-- ç¸½éƒ¨ç”¨æˆ¶ï¼šå¯é¸æ“‡åˆ†åº— -->
              <select
                v-else
                id="store_id"
                v-model="form.store_id"
                required
                class="block w-full px-2 py-2 bg-gray-700/50 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 appearance-none text-sm"
              >
                <option value="" disabled>è«‹é¸æ“‡</option>
                <option v-for="store in stores" :key="store.id" :value="store.id">
                  {{ store.name }}
                </option>
              </select>
            </div>
          </div>

          <!-- ç¬¬äºŒè¡Œï¼šä»˜æ¬¾é‡‘é¡ï¼ˆç¨ç«‹ä¸€è¡Œï¼Œå®¢è¨‚å–®æ™‚éš±è—ï¼‰ -->
          <div v-if="form.payment_method !== 'å®¢è¨‚å–®'" class="mb-3">
            <label for="amount" class="flex items-center space-x-1 text-xs font-medium text-gray-200 mb-1">
              <span>ä»˜æ¬¾é‡‘é¡</span>
              <svg v-if="lockSettings.amount" class="w-2.5 h-2.5 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
              </svg>
            </label>
            <input
              id="amount"
              v-model.number="form.amount"
              type="number"
              required
              min="0"
              class="block w-full px-3 py-2.5 bg-gray-700/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 text-base font-medium"
              placeholder="è«‹è¼¸å…¥é‡‘é¡ï¼ˆè´ˆå“/å…¬é—œå“å¯è¨­ç‚º 0ï¼‰"
            />

            <!-- æé ˜/åº—å…§æ”¯å‡ºæé†’ -->
            <div v-if="showWithdrawalReminder" class="mt-3 bg-blue-900/30 border-l-4 border-blue-500 p-4 rounded-lg">
              <div class="flex">
                <div class="flex-shrink-0">
                  <svg class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"/>
                  </svg>
                </div>
                <div class="ml-3">
                  <h3 class="text-sm font-medium text-blue-300">
                    ğŸ’¡ {{ form.payment_method === 'æé ˜' ? 'æé ˜' : 'åº—å…§æ”¯å‡º' }}æ“ä½œæé†’
                  </h3>
                  <div class="mt-2 text-sm text-blue-200">
                    <p class="font-semibold text-blue-100">è«‹å…ˆç¢ºèªä»¥ä¸‹äº‹é …ï¼š</p>
                    <ol class="list-decimal ml-5 mt-1 space-y-1">
                      <li>æª¢æŸ¥ç®¡ç†å¾Œå°çš„ã€Œ<strong class="text-blue-100">ç•¶å‰åº—è£¡ç¾é‡‘ç¸½é¡</strong>ã€æ˜¯å¦æ­£ç¢º</li>
                      <li>å¦‚ç³»çµ±é¤˜é¡ä¸æ­£ç¢ºï¼Œè«‹å…ˆè£œç™»éºæ¼çš„ç¾é‡‘æ”¶å…¥ï¼ˆå‚™è¨»è¨»æ˜ã€Œä¿®æ­£é‡‘é¡ã€ï¼‰</li>
                      <li>ç¢ºèªç³»çµ±é¤˜é¡æ­£ç¢ºå¾Œï¼Œå†è¨˜éŒ„{{ form.payment_method === 'æé ˜' ? 'æé ˜' : 'åº—å…§æ”¯å‡º' }}</li>
                    </ol>
                    <p class="mt-2 text-xs text-blue-300 border-t border-blue-700 pt-2">
                      â„¹ï¸ æ‚¨å¯ä»¥åˆ°ã€Œç®¡ç†å¾Œå°ã€æŸ¥çœ‹å„åˆ†åº—çš„ç¾é‡‘ç¸½é¡
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- å‚™è¨»å€åŸŸï¼ˆå®¢è¨‚å–®æ™‚éš±è—ï¼‰ -->
          <div v-if="form.payment_method !== 'å®¢è¨‚å–®'" class="mb-3">
            <label for="note" class="block text-xs font-medium text-gray-200 mb-1">
              å‚™è¨» <span class="text-gray-400 text-xs">(é¸å¡«ï¼Œæœ€å¤š 1000 å­—)</span>
            </label>
            <textarea
              id="note"
              v-model="form.note"
              rows="2"
              maxlength="1000"
              class="block w-full px-2 py-2 bg-gray-700/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 resize-none text-sm"
              placeholder="è«‹è¼¸å…¥å‚™è¨»è³‡è¨Š..."
            />
          </div>

          <!-- å®¢è¨‚å–®å°ˆç”¨è¡¨å–®ï¼ˆç•¶é¸æ“‡å®¢è¨‚å–®æ™‚é¡¯ç¤ºï¼‰ -->
          <div v-if="form.payment_method === 'å®¢è¨‚å–®'" class="space-y-4 xs:space-y-3 bg-slate-800/30 border border-slate-600/50 rounded-lg p-4 xs:p-3">
            <div class="flex items-center space-x-2 mb-3">
              <svg class="w-5 h-5 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
              <span class="text-cyan-300 font-medium text-sm xs:text-sm-mobile">å®¢è¨‚å–®äº¤ä»˜é€²åº¦</span>
            </div>
            
            <!-- å•†å“æ¸…å–® -->
            <div class="space-y-2 xs:space-y-1.5">
              <label class="block text-sm xs:text-sm-mobile font-medium text-gray-200">
                å•†å“æ¸…å–® <span class="text-red-400">*</span>
              </label>
              <textarea
                v-model="orderForm.products"
                :required="form.payment_method === 'å®¢è¨‚å–®'"
                rows="2"
                class="block w-full px-3 py-3 xs:py-2.5 bg-gray-700/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 resize-none text-base xs:text-base-mobile sm:text-sm"
                placeholder="ä¾‹å¦‚ï¼šActitube 6mm 50pcï¼ŒActitube 7mm"
              />
            </div>
            
            <!-- å–ä»¶äººè³‡è¨Š -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 xs:gap-3">
              <div class="space-y-2 xs:space-y-1.5">
                <label class="block text-sm xs:text-sm-mobile font-medium text-gray-200">
                  å–ä»¶åç¨± <span class="text-red-400">*</span>
                </label>
                <input
                  v-model="orderForm.customerName"
                  type="text"
                  :required="form.payment_method === 'å®¢è¨‚å–®'"
                  class="block w-full px-3 py-3 xs:py-2.5 bg-gray-700/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 text-base xs:text-base-mobile sm:text-sm min-h-touch"
                  placeholder="è«‹è¼¸å…¥å–ä»¶äººå§“å"
                />
              </div>
              
              <div class="space-y-2 xs:space-y-1.5">
                <label class="block text-sm xs:text-sm-mobile font-medium text-gray-200">
                  å–ä»¶é›»è©± <span class="text-red-400">*</span>
                </label>
                <input
                  v-model="orderForm.customerPhone"
                  type="tel"
                  :required="form.payment_method === 'å®¢è¨‚å–®'"
                  class="block w-full px-3 py-3 xs:py-2.5 bg-gray-700/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 text-base xs:text-base-mobile sm:text-sm min-h-touch"
                  placeholder="è«‹è¼¸å…¥è¯çµ¡é›»è©±"
                />
              </div>
            </div>
            
            <!-- ä»˜æ¬¾ç‹€æ³ -->
            <div class="space-y-2 xs:space-y-1.5">
              <label class="block text-sm xs:text-sm-mobile font-medium text-gray-200">
                ä»˜æ¬¾ç‹€æ³
              </label>
              <select
                v-model="orderForm.paymentStatus"
                class="block w-full px-3 py-3 xs:py-2.5 bg-gray-700/50 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 appearance-none text-base xs:text-base-mobile sm:text-sm min-h-touch"
              >
                <option value="æœªä»˜æ¬¾">æœªä»˜æ¬¾</option>
                <option value="å·²ä»˜æ¬¾">å·²ä»˜æ¬¾</option>
              </select>
            </div>
            
            <!-- ç‰©æµè²¨è™Ÿ/åº—å– -->
            <div class="space-y-2 xs:space-y-1.5">
              <label class="block text-sm xs:text-sm-mobile font-medium text-gray-200">
                ç‰©æµè²¨è™Ÿ/åº—å–
              </label>
              <input
                v-model="orderForm.logistics"
                type="text"
                class="block w-full px-3 py-3 xs:py-2.5 bg-gray-700/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 text-base xs:text-base-mobile sm:text-sm min-h-touch"
                placeholder="ä¾‹å¦‚ï¼šå…¨å®¶ å°ä¸­å¢©å°åº—"
              />
            </div>
            
            <!-- å®¢è¨‚å–®å‚™è¨» -->
            <div class="space-y-2 xs:space-y-1.5">
              <label class="block text-sm xs:text-sm-mobile font-medium text-gray-200">
                å®¢è¨‚å–®å‚™è¨»
              </label>
              <textarea
                v-model="orderForm.remarks"
                rows="2"
                class="block w-full px-3 py-3 xs:py-2.5 bg-gray-700/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 resize-none text-base xs:text-base-mobile sm:text-sm"
                placeholder="ä¾‹å¦‚ï¼šå…¨å®¶15310693084"
              />
            </div>
          </div>

          <!-- æäº¤æŒ‰éˆ•èˆ‡è¨Šæ¯ - åˆä½µåœ¨ä¸€èµ· -->
          <div class="flex items-center gap-3">
            <button
              type="submit"
              :disabled="isSubmitting"
              class="flex-shrink-0 flex justify-center items-center py-2.5 px-6 border border-transparent text-sm font-medium rounded-lg text-white bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed transform transition-all duration-200 hover:scale-105 active:scale-95 shadow-lg"
            >
              <svg v-if="isSubmitting" class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              {{
                isSubmitting
                  ? (form.payment_method === 'å®¢è¨‚å–®' ? 'å»ºç«‹ä¸­...' : 'æäº¤ä¸­...')
                  : (form.payment_method === 'å®¢è¨‚å–®' ? 'å»ºç«‹å®¢è¨‚å–®' : 'æäº¤ä»˜æ¬¾è³‡è¨Š')
              }}
            </button>

            <!-- è¨Šæ¯é¡¯ç¤º - æ©«å‘æ’åˆ— -->
            <div v-if="message" class="flex-1 flex items-center p-2.5 rounded-lg border-l-4 text-xs" :class="messageClass">
              <div class="flex-shrink-0">
                <svg v-if="messageClass.includes('green')" class="h-4 w-4 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                </svg>
                <svg v-else class="h-4 w-4 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                </svg>
              </div>
              <p class="ml-2 text-xs">{{ message }}</p>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, reactive, onMounted, watch } from 'vue'
import { useRouter } from 'vue-router'
import { paymentApi, storeApi, customerOrderApi, type PaymentData, type StoreData, type CustomerOrderData, getCurrentUserInfo } from '@/utils/api'

const router = useRouter()

const form = reactive<PaymentData>({
  paid_at: '',
  payment_method: '',
  last_five: '',
  amount: 0,
  note: '',
  store_id: undefined
})

// å®¢è¨‚å–®å°ˆç”¨è¡¨å–®è³‡æ–™
const orderForm = reactive({
  products: '',
  customerName: '',
  customerPhone: '',
  paymentStatus: 'æœªä»˜æ¬¾' as 'æœªä»˜æ¬¾' | 'å·²ä»˜æ¬¾',
  logistics: '',
  remarks: ''
})

const isSubmitting = ref(false)
const message = ref('')
const messageClass = ref('')
const currentUser = ref<string | null>(null)
const stores = ref<StoreData[]>([])
const currentUserStoreId = ref<number | null>(null)

// å­—æ®µé–å®šè¨­å®š
const lockSettings = reactive({
  time: false,
  paymentMethod: false,
  amount: false,
  store: false
})

// ç”¨æ–¼ä¿å­˜é–å®šçš„å­—æ®µå€¼
const lockedValues = reactive({
  paid_at: '',
  payment_method: '',
  amount: 0,
  store_id: undefined as number | undefined
})

// é¡¯ç¤ºæé ˜/åº—å…§æ”¯å‡ºæé†’
const showWithdrawalReminder = ref<boolean>(false)

// çµ±ä¸€çš„å°åŒ—æ™‚é–“æ ¼å¼åŒ–å‡½æ•¸ (UTC+8)
const getTaipeiDateTimeString = (date?: Date) => {
  const targetDate = date || new Date()
  // è½‰æ›ç‚ºå°åŒ—æ™‚é–“ (UTC+8)
  const taipeiDate = new Date(targetDate.getTime() + (8 * 60 * 60 * 1000))
  const year = taipeiDate.getUTCFullYear()
  const month = String(taipeiDate.getUTCMonth() + 1).padStart(2, '0')
  const day = String(taipeiDate.getUTCDate()).padStart(2, '0')
  const hours = String(taipeiDate.getUTCHours()).padStart(2, '0')
  const minutes = String(taipeiDate.getUTCMinutes()).padStart(2, '0')
  return `${year}-${month}-${day}T${hours}:${minutes}`
}


const goToAdmin = () => {
  router.push('/admin')
}

const logout = async () => {
  try {
    // å°å…¥adminApi
    const { adminApi } = await import('@/utils/api')
    // èª¿ç”¨å¾Œç«¯ç™»å‡ºAPIä¾†è¨˜éŒ„å¯©è¨ˆæ—¥èªŒ
    await adminApi.logout()
  } catch (error) {
    console.error('Error during logout:', error)
    // å³ä½¿APIèª¿ç”¨å¤±æ•—ï¼Œä»ç„¶ç¹¼çºŒç™»å‡ºæµç¨‹
  } finally {
    // æ¸…é™¤æœ¬åœ°tokenä¸¦è·³è½‰
    localStorage.removeItem('admin_token')
    router.push('/admin/login')
  }
}

// ç²å–ç•¶å‰ç”¨æˆ¶æ‰€å±¬åˆ†åº—åç¨±
const getCurrentStoreName = () => {
  if (!currentUserStoreId.value) return ''
  const store = stores.value.find(s => s.id === currentUserStoreId.value)
  return store ? `${store.name} (${store.code})` : ''
}

// ç²å–ç•¶å‰é¸ä¸­çš„åˆ†åº—åç¨±
const getSelectedStoreName = () => {
  const targetStoreId = form.store_id || currentUserStoreId.value
  if (!targetStoreId) return ''
  const store = stores.value.find(s => s.id === targetStoreId)
  return store ? store.name : ''
}

// ç›£è½ä»˜æ¬¾æ–¹å¼è®ŠåŒ–
watch(() => form.payment_method, (newMethod) => {
  if (newMethod === 'æé ˜') {
    // è‡ªå‹•è¨­å®šç‚ºç•¶å‰å°åŒ—æ™‚é–“
    form.paid_at = getTaipeiDateTimeString()
    
    // è‡ªå‹•å¡«å…¥å‚™è¨»
    const storeName = getSelectedStoreName()
    const taipeiNow = new Date(new Date().getTime() + (8 * 60 * 60 * 1000))
    const month = taipeiNow.getUTCMonth() + 1
    const date = taipeiNow.getUTCDate()
    const amount = form.amount || 0
    
    if (storeName) {
      form.note = `${storeName}å·²æ–¼${month}æœˆ${date}è™Ÿæé ˜åº—å…§ç¾é‡‘$${amount}`
    }
  }
})

// ç›£è½é‡‘é¡è®ŠåŒ–ï¼Œæ›´æ–°æé ˜å‚™è¨»
watch(() => form.amount, (newAmount) => {
  if (form.payment_method === 'æé ˜' && newAmount > 0) {
    const storeName = getSelectedStoreName()
    const taipeiNow = new Date(new Date().getTime() + (8 * 60 * 60 * 1000))
    const month = taipeiNow.getUTCMonth() + 1
    const date = taipeiNow.getUTCDate()
    
    if (storeName) {
      form.note = `${storeName}å·²æ–¼${month}æœˆ${date}è™Ÿæé ˜åº—å…§ç¾é‡‘$${newAmount}`
    }
  }
})

// ç›£è½åˆ†åº—è®ŠåŒ–ï¼Œæ›´æ–°æé ˜å‚™è¨»
watch(() => form.store_id, (newStoreId) => {
  if (form.payment_method === 'æé ˜' && form.amount > 0) {
    const store = stores.value.find(s => s.id === newStoreId)
    if (store) {
      const taipeiNow = new Date(new Date().getTime() + (8 * 60 * 60 * 1000))
      const month = taipeiNow.getUTCMonth() + 1
      const date = taipeiNow.getUTCDate()

      form.note = `${store.name}å·²æ–¼${month}æœˆ${date}è™Ÿæé ˜åº—å…§ç¾é‡‘$${form.amount}`
    }
  }
})

// ç›£è½ä»˜æ¬¾æ–¹å¼è®ŠåŒ–ï¼Œé¡¯ç¤ºæé†’
watch(() => form.payment_method, (paymentMethod) => {
  // ç•¶é¸æ“‡ã€Œæé ˜ã€æˆ–ã€Œåº—å…§æ”¯å‡ºã€æ™‚é¡¯ç¤ºæé†’
  showWithdrawalReminder.value = paymentMethod === 'æé ˜' || paymentMethod === 'åº—å…§æ”¯å‡º'
})

// ç›£è½é–å®šè¨­å®šè®ŠåŒ–ï¼Œä¿å­˜ç•¶å‰å€¼
watch(() => lockSettings.time, (isLocked) => {
  if (isLocked) {
    lockedValues.paid_at = form.paid_at
  }
})

watch(() => lockSettings.paymentMethod, (isLocked) => {
  if (isLocked) {
    lockedValues.payment_method = form.payment_method
  }
})

watch(() => lockSettings.amount, (isLocked) => {
  if (isLocked) {
    lockedValues.amount = form.amount
  }
})

watch(() => lockSettings.store, (isLocked) => {
  if (isLocked) {
    lockedValues.store_id = form.store_id
  }
})

// è¼‰å…¥åˆ†åº—æ¸…å–® - æ ¹æ“šç”¨æˆ¶æ¬Šé™éæ¿¾
const loadStores = async () => {
  try {
    const response = await storeApi.getAll()
    let allStores = response.data
    
    // ğŸ”’ æ ¹æ“šç”¨æˆ¶æ¬Šé™éæ¿¾åˆ†åº—
    const userInfo = await getCurrentUserInfo()
    if (userInfo) {
      // ç®¡ç†å“¡å¯ä»¥çœ‹åˆ°æ‰€æœ‰åˆ†åº—
      if (userInfo.role === 'admin') {
        stores.value = allStores
      } 
      // å¦‚æœç”¨æˆ¶æœ‰ accessible_storesï¼Œåªé¡¯ç¤ºæœ‰æ¬Šé™çš„åˆ†åº—
      else if (userInfo.accessible_stores && userInfo.accessible_stores.length > 0) {
        stores.value = allStores.filter(store => 
          userInfo.accessible_stores!.includes(store.id)
        )
      }
      // å¦‚æœç”¨æˆ¶åªæœ‰å–®ä¸€åˆ†åº—æ¬Šé™ï¼Œåªé¡¯ç¤ºè©²åˆ†åº—
      else if (userInfo.store_id) {
        stores.value = allStores.filter(store => store.id === userInfo.store_id)
      }
      // å¦‚æœæ²’æœ‰ä»»ä½•åˆ†åº—æ¬Šé™ï¼Œé¡¯ç¤ºç©ºåˆ—è¡¨
      else {
        stores.value = []
        console.warn('ç”¨æˆ¶æ²’æœ‰ä»»ä½•åˆ†åº—æ¬Šé™')
      }
    } else {
      stores.value = allStores // å‚™ç”¨é‚è¼¯
    }
  } catch (error) {
    console.error('Failed to load stores:', error)
    // å¦‚æœç„¡æ³•è¼‰å…¥åˆ†åº—ï¼Œæ ¹æ“šç•¶å‰ç”¨æˆ¶æ¬Šé™è¨­å®šé è¨­åˆ†åº—
    const userInfo = await getCurrentUserInfo()
    if (userInfo?.store_id) {
      // åªé¡¯ç¤ºç”¨æˆ¶æœ‰æ¬Šé™çš„åˆ†åº—
      const defaultStores = [
        { id: 1, name: 'å¤§å®‰åº—', code: 'DA', is_active: true, created_at: '', address: '', phone: '', manager: '' },
        { id: 2, name: 'ç›Šæ°‘åº—', code: 'YM', is_active: true, created_at: '', address: '', phone: '', manager: '' },
        { id: 3, name: 'é€¢ç”²åº—', code: 'FC', is_active: true, created_at: '', address: '', phone: '', manager: '' },
        { id: 4, name: 'æ¼¢ç¥åº—', code: 'HS', is_active: true, created_at: '', address: '', phone: '', manager: '' }
      ]
      
      if (userInfo.accessible_stores && userInfo.accessible_stores.length > 0) {
        stores.value = defaultStores.filter(store => 
          userInfo.accessible_stores!.includes(store.id)
        )
      } else if (userInfo.store_id) {
        stores.value = defaultStores.filter(store => store.id === userInfo.store_id)
      } else {
        stores.value = defaultStores // ç®¡ç†å“¡å‚™ç”¨
      }
    } else {
      stores.value = [] // æ²’æœ‰æ¬Šé™
    }
  }
}

// åˆå§‹åŒ–ç”¨æˆ¶è³‡è¨Šå’Œè¡¨å–®
const initializeForm = async () => {
  try {
    // è¨­å®šé è¨­æ—¥æœŸç‚ºä»Šå¤©ï¼ˆä½¿ç”¨å°åŒ—æ™‚é–“ï¼‰
    form.paid_at = getTaipeiDateTimeString()
    
    // å¼·åˆ¶è¦æ±‚ç”¨æˆ¶ç™»å…¥
    try {
      const userInfo = await getCurrentUserInfo()
      if (userInfo) {
        currentUser.value = userInfo.username
        currentUserStoreId.value = userInfo.store_id || null
        
        // å¦‚æœç”¨æˆ¶å±¬æ–¼ç‰¹å®šåˆ†åº—ï¼Œè‡ªå‹•è¨­å®šåˆ†åº—ID
        if (userInfo.store_id) {
          form.store_id = userInfo.store_id
        }
      } else {
        // æ²’æœ‰ç”¨æˆ¶ä¿¡æ¯ï¼Œé‡å®šå‘åˆ°ç™»å…¥é é¢
        router.push('/admin/login')
        return
      }
    } catch (authError) {
      // èªè­‰å¤±æ•—ï¼Œé‡å®šå‘åˆ°ç™»å…¥é é¢
      console.log('Authentication failed, redirecting to login')
      router.push('/admin/login')
      return
    }
    
    // è¼‰å…¥åˆ†åº—æ¸…å–®
    await loadStores()
  } catch (error) {
    console.error('Failed to initialize form:', error)
  }
}

const submitPayment = async () => {
  if (isSubmitting.value) return
  
  isSubmitting.value = true
  message.value = ''
  
  try {
    // å®¢è¨‚å–®ä½¿ç”¨æ–°çš„ API ç«¯é»
    if (form.payment_method === 'å®¢è¨‚å–®') {
      const customerOrderData: CustomerOrderData = {
        order_date: new Date().toLocaleDateString('zh-TW', { 
          year: 'numeric', 
          month: '2-digit', 
          day: '2-digit' 
        }).replace(/\//g, '/'),
        products: orderForm.products,
        customer_name: orderForm.customerName,
        customer_phone: orderForm.customerPhone,
        payment_status: orderForm.paymentStatus,
        logistics: orderForm.logistics,
        remarks: orderForm.remarks,
        store_id: form.store_id || currentUserStoreId.value || 1
      }
      
      console.log('Submitting customer order:', customerOrderData)
      
      const response = await customerOrderApi.create(customerOrderData)
      message.value = `å®¢è¨‚å–®å·²æˆåŠŸå»ºç«‹ï¼è¨‚å–®ç·¨è™Ÿï¼š${response.data.order.id}`
      messageClass.value = 'bg-green-900/20 border-l-green-500 text-green-300'
      
      // ä¿å­˜ç•¶å‰é–å®šå­—æ®µçš„å€¼
      if (lockSettings.time) lockedValues.paid_at = form.paid_at
      if (lockSettings.paymentMethod) lockedValues.payment_method = form.payment_method
      if (lockSettings.amount) lockedValues.amount = form.amount
      if (lockSettings.store) lockedValues.store_id = form.store_id

      // é‡ç½®è¡¨å–®ï¼Œä½†ä¿ç•™é–å®šçš„å­—æ®µ
      Object.assign(form, {
        paid_at: lockSettings.time ? lockedValues.paid_at : getTaipeiDateTimeString(),
        payment_method: lockSettings.paymentMethod ? lockedValues.payment_method : '',
        last_five: '',
        amount: lockSettings.amount ? lockedValues.amount : 0,
        note: '',
        store_id: lockSettings.store ? lockedValues.store_id : (currentUserStoreId.value || undefined)
      })
      
      // é‡ç½®å®¢è¨‚å–®è¡¨å–®
      Object.assign(orderForm, {
        products: '',
        customerName: '',
        customerPhone: '',
        paymentStatus: 'æœªä»˜æ¬¾' as 'æœªä»˜æ¬¾' | 'å·²ä»˜æ¬¾',
        logistics: '',
        remarks: ''
      })
      
      return
    }
    
    // ä¸€èˆ¬ä»˜æ¬¾è¨˜éŒ„çš„è™•ç†é‚è¼¯
    // è™•ç†ä»˜æ¬¾æ™‚é–“ï¼šçµ±ä¸€ä½¿ç”¨å°åŒ—æ™‚é–“ (UTC+8) è½‰æ›ç‚º ISO æ ¼å¼
    let paidAtDate = ''
    if (form.payment_method === 'æé ˜') {
      // æé ˜ä½¿ç”¨ç•¶å‰å°åŒ—æ™‚é–“
      const taipeiNow = new Date(new Date().getTime() + (8 * 60 * 60 * 1000))
      paidAtDate = new Date(taipeiNow.getTime() - (8 * 60 * 60 * 1000)).toISOString()
    } else {
      // å…¶ä»–ä»˜æ¬¾æ–¹å¼ä½¿ç”¨ç”¨æˆ¶é¸å®šçš„æ—¥æœŸæ™‚é–“
      if (form.paid_at) {
        // form.paid_at æ˜¯ datetime-local æ ¼å¼ (YYYY-MM-DDTHH:mm)
        // å‡è¨­è¼¸å…¥æ˜¯å°åŒ—æ™‚é–“ï¼Œè½‰æ›ç‚º UTC å†è½‰æˆ ISO å­—ç¬¦ä¸²
        const selectedDate = new Date(`${form.paid_at}:00+08:00`)
        paidAtDate = selectedDate.toISOString()
      } else {
        paidAtDate = ''
      }
    }
    
    const submitData = {
      ...form,
      paid_at: paidAtDate,
      store_id: form.store_id || currentUserStoreId.value || 1 // é è¨­ç¬¬ä¸€å€‹åˆ†åº—
    }
    
    console.log('Submitting payment data:', submitData)
    
    const response = await paymentApi.create(submitData)
    message.value = `ä»˜æ¬¾è³‡è¨Šå·²æˆåŠŸæäº¤ï¼è¿½è¹¤ç·¨è™Ÿï¼š${response.data.uuid}`
    messageClass.value = 'bg-green-900/20 border-l-green-500 text-green-300'
    
    // ä¿å­˜ç•¶å‰é–å®šå­—æ®µçš„å€¼
    if (lockSettings.time) lockedValues.paid_at = form.paid_at
    if (lockSettings.paymentMethod) lockedValues.payment_method = form.payment_method
    if (lockSettings.amount) lockedValues.amount = form.amount
    if (lockSettings.store) lockedValues.store_id = form.store_id

    // é‡ç½®è¡¨å–®ï¼Œä½†ä¿ç•™é–å®šçš„å­—æ®µ
    Object.assign(form, {
      paid_at: lockSettings.time ? lockedValues.paid_at : getTaipeiDateTimeString(), // é‡ç½®ç‚ºä»Šå¤©æ—¥æœŸï¼ˆå°åŒ—æ™‚é–“ï¼‰
      payment_method: lockSettings.paymentMethod ? lockedValues.payment_method : '',
      last_five: '',
      amount: lockSettings.amount ? lockedValues.amount : 0,
      note: '',
      store_id: lockSettings.store ? lockedValues.store_id : (currentUserStoreId.value || undefined)
    })
    
  } catch (error: any) {
    console.error('Submit error:', error)
    
    // é¡¯ç¤ºå…·é«”çš„é©—è­‰éŒ¯èª¤
    if (error.response?.data?.errors) {
      const errorMessages = error.response.data.errors.map((err: any) => err.message).join(', ')
      message.value = `é©—è­‰éŒ¯èª¤ï¼š${errorMessages}`
    } else {
      message.value = error.response?.data?.message || 'æäº¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦'
    }
    messageClass.value = 'bg-red-900/20 border-l-red-500 text-red-300'
  } finally {
    isSubmitting.value = false
  }
}

const goToOrders = () => {
  router.push('/admin/customer-orders')
}

onMounted(() => {
  initializeForm()
})
</script>